<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CS2 Clips — Permanent JSON + Autoload</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#061126; --card:#071428; --muted:#9aa5b8; --accent:#10b981;
      --radius:14px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,#041028 0%, #071428 100%);color:#eaf2ff;padding:28px;
      -webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
    }
    .container{max-width:1100px;margin:0 auto;}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px}
    h1{margin:0;font-size:20px;font-weight:800}
    .lead{margin:0;color:var(--muted);font-size:13px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); padding:14px;border-radius:12px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 22px rgba(0,0,0,0.6)}
    .form-row{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
    input[type="text"], input[type="url"], textarea, input[type="number"]{
      flex:1;padding:10px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.05);
      color:inherit;font-size:14px;
    }
    textarea{min-height:68px;resize:vertical}
    button.primary{background:var(--accent);border:none;color:#042017;padding:10px 14px;border-radius:999px;font-weight:800;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);padding:8px 12px;border-radius:10px;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .grid{display:grid;grid-template-columns:repeat(1,1fr);gap:18px;margin-top:18px}
    @media(min-width:640px){ .grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:980px){ .grid{grid-template-columns:repeat(3,1fr)} }

    /* clip card */
    .clip{position:relative;border-radius:var(--radius);overflow:hidden;background:var(--card);border:1px solid rgba(255,255,255,0.03);transition:transform .16s,box-shadow .16s}
    .clip:hover{transform:translateY(-6px);box-shadow:0 28px 60px rgba(0,0,0,0.6)}
    .titlebar{position:absolute;left:0;right:0;top:0;padding:12px;background:linear-gradient(180deg, rgba(2,6,23,0.75), rgba(2,6,23,0.2));backdrop-filter:blur(6px);display:flex;gap:8px;align-items:center;border-bottom:1px solid rgba(255,255,255,0.02);z-index:3}
    .titlebar h3{margin:0;font-size:14px;font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .titlebar .date{margin-left:auto;font-size:12px;color:var(--muted);font-weight:600}

    .video-mid{padding-top:56.25%;position:relative;background:#000}
    .video-mid iframe, .video-mid img{position:absolute;left:0;top:0;width:100%;height:100%;object-fit:cover;border:0}
    .desc{padding:10px 12px;border-top:1px solid rgba(255,255,255,0.02);font-size:13px;color:#dfe9f8;min-height:44px}

    .card-actions{display:flex;gap:8px;padding:10px 12px;align-items:center}
    .link{color:var(--muted);text-decoration:none;font-size:13px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
    .danger{color:#ff6b7b;background:transparent;border:none;padding:8px 10px;border-radius:8px;cursor:pointer;font-weight:700}

    /* overlay */
    .overlay{position:fixed;inset:0;background:rgba(2,6,13,0.7);display:flex;align-items:center;justify-content:center;z-index:9999;padding:20px}
    .player-box{width:100%;max-width:980px;border-radius:10px;background:var(--card);overflow:hidden;box-shadow:0 40px 100px rgba(0,0,0,0.6)}
    .player-iframe{width:100%;height:56.25vw;max-height:640px;border:0;display:block}
    .small{font-size:12px;color:var(--muted)}
    footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    .searchwrap{display:flex;gap:8px;align-items:center}
    .searchwrap input{padding:8px 10px;border-radius:8px}
    #autoloadStatus{font-size:13px;color:var(--muted);margin-left:10px}
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>CS2 Clips — Autoload JSON</h1>
        <p class="lead">Autoloads a JSON file if present. Put <code>cs2-clips.json</code> next to this HTML — or use <code>?json=URL</code>.</p>
      </div>
      <div style="display:flex;align-items:center">
        <div class="muted">Saved in browser + downloadable JSON</div>
        <div id="autoloadStatus" aria-live="polite"></div>
      </div>
    </header>

    <section class="card" aria-label="Add clip">
      <form id="addForm">
        <div class="form-row">
          <input id="videoUrl" type="url" placeholder="YouTube URL or video ID (required)" required>
          <input id="videoTitle" type="text" placeholder="Title (required)" required>
        </div>
        <div class="form-row">
          <textarea id="videoDesc" placeholder="Short description: what you did in this clip (optional)"></textarea>
        </div>

        <div style="display:flex;gap:8px;align-items:center;justify-content:space-between">
          <div class="controls">
            <button class="primary" type="submit">Add clip</button>
            <button class="ghost" type="button" id="clearAll">Clear all</button>
          </div>

          <div style="display:flex;gap:8px;align-items:center">
            <div class="searchwrap">
              <input id="searchInput" type="text" placeholder="Search title or description..." style="min-width:220px">
            </div>
            <div style="display:flex;gap:6px">
              <button id="exportBtn" type="button" class="ghost">Download JSON</button>
              <button id="copyBtn" type="button" class="ghost">Copy JSON</button>
              <button id="importBtn" type="button" class="ghost">Import JSON</button>
            </div>
          </div>
        </div>
      </form>
    </section>

    <main id="gallery" class="grid" aria-live="polite" style="margin-top:18px"></main>

    <footer>
      <div>To autoload: place <code>cs2-clips.json</code> (or <code>clips.json</code>) in the same folder as this HTML and serve the folder via HTTP (e.g. <code>python -m http.server</code>).</div>
      <div class="small" style="margin-top:6px">Alternatively open this page with <code>?json=https://example.com/myclips.json</code>. If a direct fetch fails it will try a public proxy automatically.</div>
    </footer>
  </div>

  <input type="file" id="jsonFile" accept="application/json" style="display:none">

  <script>
    /* ---------- Utilities ---------- */
    const LS_KEY = 'cs2_clips_permanent_v1';
    const gallery = document.getElementById('gallery');
    const statusEl = document.getElementById('autoloadStatus');
    let clips = loadClips();

    function saveClips(list){ localStorage.setItem(LS_KEY, JSON.stringify(list)) }
    function loadClips(){ try { return JSON.parse(localStorage.getItem(LS_KEY)) || [] } catch(e){ return [] } }
    function nowIso(){ return new Date().toISOString() }
    function youtubeIdFrom(input){
      if(!input) return null;
      input = input.trim();
      if(/^[a-zA-Z0-9_-]{11}$/.test(input)) return input;
      try{
        const u = new URL(input);
        if(u.hostname.includes('youtu.be')) return u.pathname.slice(1).split('?')[0];
        if(u.hostname.includes('youtube.com')){
          const v = u.searchParams.get('v');
          if(v) return v;
          const parts = u.pathname.split('/').filter(Boolean);
          if(parts[0] === 'shorts' && parts[1]) return parts[1];
        }
      }catch(e){}
      const m = input.match(/v=([a-zA-Z0-9_-]{11})/);
      if(m) return m[1];
      const mm = input.match(/([a-zA-Z0-9_-]{11})/);
      return mm ? mm[1] : null;
    }
    function thumbUrl(id){ return `https://img.youtube.com/vi/${id}/hqdefault.jpg` }
    function embedUrl(id){ return `https://www.youtube.com/embed/${id}` }

    /* ---------- Render ---------- */
    function renderGallery(filterText = ''){
      gallery.innerHTML = '';
      const f = (filterText || '').toLowerCase().trim();
      const filtered = clips.filter(c => {
        if(!f) return true;
        return (c.title || '').toLowerCase().includes(f) || (c.description || '').toLowerCase().includes(f);
      });

      if(filtered.length === 0){
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.style.gridColumn = '1 / -1';
        empty.innerHTML = '<div style="padding:28px;text-align:center;color:var(--muted)">No clips — add some or import a JSON file.</div>';
        gallery.appendChild(empty);
        return;
      }

      filtered.forEach(clip => {
        const el = document.createElement('article');
        el.className = 'clip';
        el.innerHTML = `
          <div class="titlebar">
            <h3 title="${escapeHtml(clip.title)}">${escapeHtml(clip.title)}</h3>
            <div class="date">${new Date(clip.addedAt).toLocaleDateString()}</div>
          </div>

          <div class="video-mid" data-id="${clip.id}">
            <img src="${thumbUrl(clip.id)}" alt="${escapeHtml(clip.title)}" loading="lazy">
          </div>

          <div class="desc">${escapeHtml(clip.description || '')}</div>

          <div class="card-actions">
            <button class="ghost" data-load="${clip.id}">Load video</button>
            <a class="link" href="https://youtu.be/${clip.id}" target="_blank" rel="noreferrer">Open on YouTube</a>
            <button class="danger" data-remove="${clip.id}" title="Remove clip">Remove</button>
          </div>
        `;
        gallery.appendChild(el);
      });
    }

    function escapeHtml(s){ return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') }

    /* ---------- Add / Remove / Load ---------- */
    document.getElementById('addForm').addEventListener('submit', e => {
      e.preventDefault();
      const url = document.getElementById('videoUrl').value.trim();
      const title = document.getElementById('videoTitle').value.trim();
      const desc = document.getElementById('videoDesc').value.trim();
      const id = youtubeIdFrom(url);
      if(!id){ alert('Enter a valid YouTube URL or 11-character video ID'); return; }
      if(!title){ alert('Please add a title'); return; }
      if(clips.some(c=>c.id === id)){
        if(!confirm('This video is already in the gallery. Add duplicate anyway?')) return;
      }
      const item = { id, title, description: desc || '', addedAt: nowIso() };
      clips.unshift(item);
      saveClips(clips);
      renderGallery(document.getElementById('searchInput').value);
      document.getElementById('videoUrl').value = '';
      document.getElementById('videoTitle').value = '';
      document.getElementById('videoDesc').value = '';
    });

    gallery.addEventListener('click', e => {
      const loadId = e.target.closest('[data-load]')?.getAttribute('data-load');
      if(loadId){
        const wrapper = e.target.closest('.clip').querySelector('.video-mid');
        wrapper.innerHTML = `<iframe src="${embedUrl(loadId)}" allow="autoplay; encrypted-media" allowfullscreen loading="lazy"></iframe>`;
        return;
      }
      const removeId = e.target.closest('[data-remove]')?.getAttribute('data-remove');
      if(removeId){
        if(confirm('Remove this clip from your gallery?')) {
          clips = clips.filter(c=>c.id !== removeId);
          saveClips(clips);
          renderGallery(document.getElementById('searchInput').value);
        }
      }
    });

    /* ---------- Search ---------- */
    document.getElementById('searchInput').addEventListener('input', e => {
      renderGallery(e.target.value);
    });

    /* ---------- Export / Copy / Import ---------- */
    document.getElementById('exportBtn').addEventListener('click', () => {
      const data = JSON.stringify(clips, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'cs2-clips.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    document.getElementById('copyBtn').addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(JSON.stringify(clips, null, 2));
        alert('JSON copied to clipboard — you can paste and send it.');
      } catch (err) {
        alert('Copy failed: ' + (err && err.message ? err.message : err));
      }
    });

    document.getElementById('importBtn').addEventListener('click', () => {
      const input = document.getElementById('jsonFile');
      input.onchange = async (ev) => {
        const f = ev.target.files[0]; if(!f) return;
        try {
          const txt = await f.text();
          const json = JSON.parse(txt);
          if(!Array.isArray(json)) throw new Error('JSON must be an array of clip objects');
          const existing = new Set(clips.map(c=>c.id));
          const toAdd = [];
          for(const item of json){
            const id = item.id || youtubeIdFrom(item.url || '');
            if(!id) continue;
            if(existing.has(id)) continue;
            toAdd.push({
              id,
              title: item.title || item.name || `Clip ${id}`,
              description: item.description || item.desc || '',
              addedAt: item.addedAt || nowIso()
            });
            existing.add(id);
          }
          if(toAdd.length === 0) return alert('No new clips found to import (duplicates ignored).');
          clips = toAdd.concat(clips);
          saveClips(clips); renderGallery(document.getElementById('searchInput').value);
          alert(`Imported ${toAdd.length} clips from JSON`);
        } catch (err) {
          alert('Import failed: ' + (err && err.message ? err.message : err));
        } finally {
          input.value = '';
        }
      };
      input.click();
    });

    /* ---------- Clear All ---------- */
    document.getElementById('clearAll').addEventListener('click', () => {
      if(confirm('Clear the entire gallery from this browser? This cannot be undone.')) {
        clips = []; saveClips(clips); renderGallery();
      }
    });

    /* ---------- Autoload JSON logic ---------- */
    async function tryFetchJson(url, useProxyIfFail = true){
      // Try direct fetch first
      try {
        const res = await fetch(url, {cache: 'no-store'});
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const text = await res.text();
        const json = JSON.parse(text);
        return json;
      } catch (err) {
        if(!useProxyIfFail) throw err;
        // Attempt AllOrigins proxy fallback
        try {
          const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(url);
          const r2 = await fetch(proxy);
          if(!r2.ok) throw new Error('Proxy HTTP ' + r2.status);
          const text2 = await r2.text();
          return JSON.parse(text2);
        } catch (err2) {
          throw err; // return original error
        }
      }
    }

    async function autoloadJson(){
      const params = new URLSearchParams(location.search);
      const explicitUrl = params.get('json') || params.get('url') || null;
      const candidateNames = explicitUrl ? [explicitUrl] : ['cs2-clips.json', 'clips.json', 'cs2-clips-permanent.json'];
      statusEl.textContent = 'Checking for autoload JSON…';

      for(const cand of candidateNames){
        try {
          // If cand is relative path and page loaded with file://, fetch may fail — we try anyway
          const json = await tryFetchJson(cand).catch(e => { throw e; });
          if(Array.isArray(json)){
            // Normalize & merge, dedupe by id
            const existing = new Set(clips.map(c=>c.id));
            const toAdd = [];
            for(const item of json){
              const id = item.id || item.videoId || youtubeIdFrom(item.url || item.link || item.videoUrl || '');
              if(!id) continue;
              if(existing.has(id)) continue;
              toAdd.push({
                id,
                title: item.title || item.name || `Clip ${id}`,
                description: item.description || item.desc || item.summary || '',
                addedAt: item.addedAt || nowIso()
              });
              existing.add(id);
            }
            if(toAdd.length > 0){
              clips = toAdd.concat(clips);
              saveClips(clips);
              renderGallery();
              statusEl.textContent = `Autoload: added ${toAdd.length} clips from ${cand}`;
              console.log(`Autoloaded ${toAdd.length} clips from ${cand}`);
            } else {
              statusEl.textContent = `Autoload: found ${cand} but no new clips (duplicates ignored)`;
            }
            return;
          } else {
            // The JSON wasn't an array — try to see if it's an object with items
            if(json && Array.isArray(json.items)){
              const arr = json.items;
              // proceed same as above
              const existing = new Set(clips.map(c=>c.id));
              const toAdd = [];
              for(const item of arr){
                const id = item.id?.videoId || item.id?.kind ? (item.id.videoId || youtubeIdFrom(item.link || item.url || '')) : (item.id || youtubeIdFrom(item.url || item.link || ''));
                if(!id) continue;
                if(existing.has(id)) continue;
                toAdd.push({
                  id,
                  title: item.title || item.snippet?.title || `Clip ${id}`,
                  description: item.description || item.snippet?.description || '',
                  addedAt: item.addedAt || nowIso()
                });
                existing.add(id);
              }
              if(toAdd.length > 0){
                clips = toAdd.concat(clips);
                saveClips(clips);
                renderGallery();
                statusEl.textContent = `Autoload: added ${toAdd.length} clips from ${cand}`;
                return;
              } else {
                statusEl.textContent = `Autoload: found ${cand} but no new clips (duplicates ignored)`;
                return;
              }
            }
            // not array and no items -> ignore
            continue;
          }
        } catch (err){
          // try next candidate
          console.warn('Autoload attempt failed for', cand, err);
          statusEl.textContent = `Autoload: checking ${cand} (not found or blocked)`;
          // small pause to avoid spamming proxies
          await new Promise(r => setTimeout(r, 200));
          continue;
        }
      }
      // if we got here nothing autoloaded
      statusEl.textContent = 'Autoload: no JSON found automatically';
    }

    /* ---------- Init ---------- */
    renderGallery();
    // Run autoload but don't block initial UI
    autoloadJson().catch(e => {
      console.warn('Autoload error', e);
      statusEl.textContent = 'Autoload: failed (check console)';
    });

    console.log('CS2 Clips (autoload) loaded — place cs2-clips.json next to the HTML or use ?json=URL to load a remote JSON.');
  </script>
</body>
</html>
